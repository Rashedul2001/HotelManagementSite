@* TODO: implement the sorting-/*-//*+9g and searching methods  *@
@* TODO: implement the pagination like rooms has later *@

@using HotelManagementSite.Models.ViewModels
@model PagedResult<UserModel>
@{
    ViewData["Title"] = "Hotel Users";
    Layout = "_AdminLayout";

}

<!-- Main Content -->
<main class="main-content">
    <div class="p-8">
        <div class="animate-fade-in space-y-6">
            <!-- Header -->
            <div class="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
                <div>
                    <h1 class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-3xl font-bold text-transparent">
                        Hotel Users
                    </h1>
                    <p class="mt-1 text-gray-600">Manage your hotel staff and users</p>
                </div>

                @* Cre*ate User Modal Trigger *@
                <button id="openModalBtn" class="animate-pulse-glow transform rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 px-6 py-3 font-bold text-white shadow-lg transition-all duration-300 hover:scale-105 hover:from-blue-600 hover:to-purple-700">
                    <span class="flex items-center space-x-2">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>Create New User</span>
                    </span>
                </button>
            </div>
            @* search and page size *@
            <form method="get" class="flex flex-col items-center justify-between gap-4 sm:flex-row" id="searchForm">
                <div class="relative max-w-md flex-1">
                    <i class="fas fa-search -translate-y-1/2 absolute left-3 top-1/2 transform text-gray-400"></i>
                    <input type="text" name="searchTerm" id="searchBox" value="@(Model?.SearchTerm ?? "")" placeholder="Search users..." class="form-input pl-10" />
                </div>
                <div class="flex gap-2">
                    <select name="pageSize" id="pageSize" class="form-select">
                        <option value="5" selected="@(Model?.PageSize == 5)">5</option>
                        <option value="10" selected="@(Model?.PageSize == 10)">10</option>
                        <option value="20" selected="@(Model?.PageSize == 20)">20</option>
                        <option value="50" selected="@(Model?.PageSize == 50)">50</option>
                        <option value="100" selected="@(Model?.PageSize == 100)">All</option>
                    </select>
                    <button type="button" id="searchBtn" class="rounded-xl bg-blue-500 px-4 py-2 text-white transition-colors duration-200 hover:bg-blue-600">
                        <svg viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" data--h-bstatus="0OBSERVED">
                            <g id="SVGRepo_bgCarrier" stroke-width="0" data--h-bstatus="0OBSERVED"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" data--h-bstatus="0OBSERVED"></g>
                            <g id="SVGRepo_iconCarrier" data--h-bstatus="0OBSERVED"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.5 17c1.71 0 3.287-.573 4.55-1.537l4.743 4.744a1 1 0 0 0 1.414-1.414l-4.744-4.744A7.5 7.5 0 1 0 9.5 17zM15 9.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" fill="#000000" data-darkreader-inline-fill="" style="--darkreader-inline-fill: var(--darkreader-background-000000, #000000);" data--h-bstatus="0OBSERVED"></path></g>
                        </svg>
                    </button>
                </div>
            </form>
            <div id="resultContainerWrapper" class="relative min-h-[200px]">
                
                @await Html.PartialAsync("Partials/_pageLoader") 

                <div id="UsersContainer">
                    @* All Users will be constructed by the given ajax _UsersTable partial View *@

                </div>
            </div>
        </div>
    </div>
</main>
@* // Modal for c///0reating a new user *@
@await Html.PartialAsync("Partials/_CreateUserModal")






@section Scripts {
    <script>
        // Global variables and functions
        let currentPage = 1;
        
        // Loader functions
        function showLoader() {
            const loader = document.querySelector('#localLoader');
            if (loader) {
                loader.classList.remove('hidden');
            } else {
                console.warn('Loader element not found');
            }
        }
        
        function hideLoader() {
            const loader = document.querySelector('#localLoader');
            if (loader) {
                loader.classList.add('hidden');
            }
        }
        
        // Function to get current form values
        function getCurrentFormValues() {
            return {
                searchTerm: $('#searchBox').val() || '',
                sortBy: 'name', // Default since we don't have sort controls visible
                sortOrder: 'asc', // Default since we don't have sort controls visible
                pageSize: parseInt($('#pageSize').val()) || 5
            };
        }
        
        // Function to load users via AJAX
        function loadUsers(page = 1, searchTerm = '', sortBy = 'name', sortOrder = 'asc', pageSize = 5) {
            console.log('Loading users with params:', { page, searchTerm, sortBy, sortOrder, pageSize });
            showLoader();
            
            $.ajax({
                url: '/Admin/GetUsers',
                type: 'GET',
                data: {
                    currentPage: page,
                    searchTerm: searchTerm,
                    sortBy: sortBy,
                    sortOrder: sortOrder,
                    pageSize: pageSize
                },
                success: function (data) {
                    console.log('AJAX success');
                    $('#UsersContainer').html(data);
                },
                error: function (xhr, status, error) {
                    console.error('AJAX error:', { status, error, xhr });
                    alert('Error loading users. Please try again. Error: ' + error);
                },
                complete: function () {
                    hideLoader();
                }
            });
        }
        
        $(document).ready(function() {
            // Load initial data
            loadUsers();

            let timer; // debounce to avoid too many requests

            // Handle search input with debounce
            $("#searchBox").on("input", function () {
                clearTimeout(timer);
                const query = $(this).val();
                const formValues = getCurrentFormValues();

                // Start debounce (wait until user stops typing for 300ms)
                timer = setTimeout(function () {
                    console.log('Search query:', query);
                    currentPage = 1; // Reset to first page on new search
                    loadUsers(currentPage, query, formValues.sortBy, formValues.sortOrder, formValues.pageSize);
                }, 300);
            });
            
            // Handle page size changes
            $('#pageSize').on('change', function() {
                const formValues = getCurrentFormValues();
                currentPage = 1; // Reset to first page
                loadUsers(currentPage, formValues.searchTerm, formValues.sortBy, formValues.sortOrder, formValues.pageSize);
            });
            
            // Handle pagination clicks (delegated event)
            $(document).on('click', '.page-btn', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                if (page && page !== currentPage) {
                    currentPage = page;
                    const formValues = getCurrentFormValues();
                    loadUsers(currentPage, formValues.searchTerm, formValues.sortBy, formValues.sortOrder, formValues.pageSize);
                }
            });

            // Handle search button click
            $('#searchBtn').on('click', function(e) {
                e.preventDefault();
                const formValues = getCurrentFormValues();
                currentPage = 1; // Reset to first page on new search
                loadUsers(currentPage, formValues.searchTerm, formValues.sortBy, formValues.sortOrder, formValues.pageSize);
            });

            // Handle Enter key in search input
            $('#searchBox').on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    e.preventDefault();
                    $('#searchBtn').click();
                }
            });
        });

        class CreateUserModal {
            constructor() {
                this.modal = document.getElementById('modalBackdrop');
                this.modalContent = document.getElementById('modalContent');
                this.openBtn = document.getElementById('openModalBtn');
                this.closeBtn = document.getElementById('closeModalBtn');
                this.cancelBtn = document.getElementById('cancelBtn');
                this.form = document.getElementById('createUserForm');
                this.profileImageInput = document.querySelector('input[name="ProfileImage"]');
                this.imagePreview = document.getElementById('imagePreview');

                this.init();
            }

            init() {
                this.bindEvents();
                this.setupImagePreview();
                this.setupFormValidation();
            }

            bindEvents() {
                this.openBtn.addEventListener('click', () => this.openModal());
                this.closeBtn.addEventListener('click', () => this.closeModal());
                this.cancelBtn.addEventListener('click', () => this.closeModal());

                this.form.addEventListener('submit', (e) => this.handleSubmit(e));

                // Escape key to close modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !this.modal.classList.contains('hidden')) {
                        this.closeModal();
                    }
                });
            }

            setupImagePreview() {
                if (this.profileImageInput) {
                    this.profileImageInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            // Validate file type
                            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                            if (!allowedTypes.includes(file.type.toLowerCase())) {
                                this.showNotification('Invalid image format. Only JPEG, PNG, and GIF are allowed.', 'error');
                                e.target.value = '';
                                return;
                            }

                            // Validate file size (5MB)
                            if (file.size > 5 * 1024 * 1024) {
                                this.showNotification('Image file size cannot exceed 5MB.', 'error');
                                e.target.value = '';
                                return;
                            }

                            const reader = new FileReader();
                            reader.onload = (e) => {
                                this.imagePreview.innerHTML = `
                                    <img src="${e.target.result}" alt="Profile Preview"
                                         class="h-full w-full rounded-full object-cover">
                                `;
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            }

            setupFormValidation() {
                const password = document.getElementById('Password');
                const confirmPassword = document.getElementById('ConfirmPassword');

                if (password && confirmPassword) {
                    confirmPassword.addEventListener('input', () => {
                        if (password.value !== confirmPassword.value) {
                            confirmPassword.setCustomValidity('Passwords do not match');
                        } else {
                            confirmPassword.setCustomValidity('');
                        }
                    });
                }
            }

            openModal() {
                this.modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                // Add stagger animation to form fields
                const formFields = this.form.querySelectorAll('input, textarea, select');
                formFields.forEach((field, index) => {
                    field.style.opacity = '0';
                    field.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        field.style.transition = 'all 0.3s ease-out';
                        field.style.opacity = '1';
                        field.style.transform = 'translateY(0)';
                    }, index * 50);
                });
            }

            closeModal() {
                this.modalContent.style.transform = 'translateY(-100px)';
                this.modalContent.style.opacity = '0';

                setTimeout(() => {
                    this.modal.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                    this.resetForm();
                    this.modalContent.style.transform = '';
                    this.modalContent.style.opacity = '';
                }, 300);
            }

            resetForm() {
                this.form.reset();
                this.clearErrors();
                this.imagePreview.innerHTML = `
                    <svg class="h-16 w-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                `;
            }

            clearErrors() {
                const errorElements = this.form.querySelectorAll('.error-message');
                errorElements.forEach(el => el.remove());

                const inputs = this.form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.classList.remove('border-red-500');
                });
            }

            showFieldErrors(errors) {
                this.clearErrors();

                errors.forEach(error => {
                    // Try to match field names from error messages
                    const field = this.extractFieldFromError(error);
                    const input = this.form.querySelector(`[name="${field}"]`);

                    if (input) {
                        input.classList.add('border-red-500');

                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message text-red-400 text-sm mt-1';
                        errorDiv.textContent = error;

                        input.parentNode.appendChild(errorDiv);
                    }
                });
            }

            extractFieldFromError(errorMessage) {
                const lowerError = errorMessage.toLowerCase();
                if (lowerError.includes('email')) return 'Email';
                if (lowerError.includes('password')) return 'Password';
                if (lowerError.includes('name')) return 'Name';
                if (lowerError.includes('role')) return 'Role';
                if (lowerError.includes('phone')) return 'PhoneNumber';
                if (lowerError.includes('nid')) return 'NID';
                if (lowerError.includes('address')) return 'Address';
                if (lowerError.includes('about')) return 'About';
                return '';
            }

            async handleSubmit(e) {
                e.preventDefault();

                if (!this.form.checkValidity()) {
                    this.form.reportValidity();
                    return;
                }

                // Show loading state
                const submitBtn = document.getElementById('submitBtn');
                const originalContent = submitBtn.innerHTML;

                submitBtn.innerHTML = `
                    <span class="flex items-center justify-center space-x-2">
                        <svg class="h-5 w-5 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Creating User...</span>
                    </span>
                `;
                submitBtn.disabled = true;

                try {
                    // Create FormData from form
                    const formData = new FormData(this.form);

                    const response = await fetch('/Admin/CreateUser', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showSuccessMessage(result.message);

                        // Close modal after success and refresh users list
                        setTimeout(() => {
                            this.closeModal();
                            // Refresh the users list
                            const formValues = getCurrentFormValues();
                            loadUsers(currentPage, formValues.searchTerm, formValues.sortBy, formValues.sortOrder, formValues.pageSize);
                        }, 2000);
                    } else {
                        this.showErrorMessage(result.message || 'User creation failed', result.errors);
                    }
                } catch (error) {
                    console.error('Error creating user:', error);
                    this.showErrorMessage('An error occurred while creating the user. Please try again.');
                } finally {
                    // Reset button
                    submitBtn.innerHTML = originalContent;
                    submitBtn.disabled = false;
                }
            }

            showSuccessMessage(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-[60] animate-slide-in';
                successDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>${message}</span>
                    </div>
                `;

                document.body.appendChild(successDiv);

                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
            }

            showErrorMessage(message, errors = []) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-[60] animate-slide-in max-w-md';

                let errorContent = `
                    <div class="flex items-start space-x-2">
                        <svg class="mt-0.5 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        <div>
                            <div class="font-medium">${message}</div>
                `;

                if (errors && errors.length > 0) {
                    errorContent += `
                        <ul class="mt-1 list-inside list-disc text-sm">
                            ${errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    `;
                }

                errorContent += `
                        </div>
                    </div>
                `;

                errorDiv.innerHTML = errorContent;
                document.body.appendChild(errorDiv);

                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
            
            showNotification(message, type = 'info') {
                const div = document.createElement('div');
                div.className = `
                    fixed top-4 right-4 z-[60] px-6 py-3 rounded-lg shadow-lg text-white animate-slide-in
                    ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'}`;
                div.innerHTML = `<div>${message}</div>`;

                document.body.appendChild(div);

                setTimeout(() => {
                    div.remove();
                }, 4000);
            }
        }

        // Initialize the modal when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new CreateUserModal();
        });
    </script>
}
@section Styles {
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .neon-border {
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5), inset 0 0 10px rgba(59, 130, 246, 0.1);
        }

        .input-glow:focus {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
            border-color: rgba(59, 130, 246, 0.8);
        }

        .gradient-text {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Loader dots animation */
        .loader-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #3b82f6;
            animation: loader-bounce 1.4s ease-in-out infinite both;
        }

        .loader-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; }
        .loader-dot:nth-child(3) { animation-delay: 0s; }
        .loader-dot:nth-child(4) { animation-delay: 0.16s; }
        .loader-dot:nth-child(5) { animation-delay: 0.32s; }

        @@keyframes loader-bounce {
            0%, 80%, 100% {
                transform: scale(0);
            } 40% {
                transform: scale(1);
            }
        }
    </style>
}

